name: Auto Validator

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.validate.outputs.result }}

    steps:
      - name: ðŸ” Fetch base and PR versions.json
        id: fetch
        run: |
          echo "Fetching base and PR versions.json..."
          curl -s -o base.json https://raw.githubusercontent.com/${{ github.repository }}/${{ github.base_ref }}/versions.json
          curl -s -o pr.json https://raw.githubusercontent.com/${{ github.event.pull_request.head.repo.full_name }}/${{ github.event.pull_request.head.ref }}/versions.json

      - name: ðŸ”Ž Validate versions.json changes
        id: validate
        run: |
          echo "ðŸ” Comparing base.json vs pr.json..."
          diff_output=$(diff -u base.json pr.json || true)

          added=$(echo "$diff_output" | grep '^+' | grep -v -- '+++' || true)
          removed=$(echo "$diff_output" | grep '^-' | grep -v -- '---' || true)

          echo "Added lines:"
          echo "$added"
          echo "Removed lines:"
          echo "$removed"

          # âœ… Check JSON syntax
          if ! jq empty pr.json; then
            echo "result=âŒ Denied: Invalid JSON syntax." >> $GITHUB_OUTPUT
            exit 0
          fi

          # âš ï¸ No file changes detected
          if [[ -z "$added$removed" ]]; then
            echo "result=âš ï¸ Warning: No file changes detected." >> $GITHUB_OUTPUT
            exit 0
          fi

          # ðŸš« Internal addons are protected
          if echo "$added$removed" | grep -q '"external": false'; then
            echo "result=âŒ Denied: Modifying internal addons is not allowed." >> $GITHUB_OUTPUT
            exit 0
          fi

          # ðŸ†• Added new external addon
          if echo "$added" | grep -q '"external": true' && ! echo "$removed" | grep -q '"addons"'; then
            echo "result=âœ… Approved: All checks passed. Ready to merge!" >> $GITHUB_OUTPUT
            exit 0
          fi

          # â³ Allowed fields for manual review
          allowed_fields_regex='"(version|description|releaseDate|lastUpdated|changelog|urgent|breaking)"'

          if echo "$added$removed" | grep -Eq "$allowed_fields_regex" && \
             ! echo "$added$removed" | grep -Eq '"(author|homepage|repository|supportServer|downloadUrl|external)"'; then
            echo "result=â³ Pending: Manual review required (allowed fields modified)." >> $GITHUB_OUTPUT
            exit 0
          fi

          # âŒ Everything else denied
          echo "result=âŒ Denied: Modifying existing addons is not allowed." >> $GITHUB_OUTPUT
          exit 0



      - name: Checkout for gh CLI
        if: always()
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 1

      - name: ðŸ’¬ Comment validation results on PR
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "ðŸ’¬ Commenting validation results on PR #${PR_NUMBER}"
          gh pr comment "$PR_NUMBER" -R "${{ github.repository }}" --delete-last --yes || true
          gh pr comment "$PR_NUMBER" -R "${{ github.repository }}" --body $'ðŸ¤– **Auto Validator Results [auto-validator]**\n\n${{ steps.validate.outputs.result }}'

      - name: âœ… Enable auto-merge for approved PRs
        if: contains(steps.validate.outputs.result, 'Approved')
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          pull-request-number: ${{ github.event.pull_request.number }}
          merge-method: squash
