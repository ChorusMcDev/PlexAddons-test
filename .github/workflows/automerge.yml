name: Auto Merge Safe PRs

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: write

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - run: sudo apt-get install -y jq

      - id: validation
        run: |
          echo "üß© Validating PR..."
          changed=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          if [ "$changed" != "versions.json" ]; then
            echo "‚ùå Only versions.json may be modified"
            exit 1
          fi
          removed=$(git diff origin/${{ github.base_ref }}...HEAD -- versions.json | grep '^-' | grep -v '^---' || true)
          if [ -n "$removed" ]; then
            echo "‚ùå Lines removed or modified. Only additions allowed."
            exit 1
          fi
          jq empty versions.json || exit 1
          base_json=$(git show origin/${{ github.base_ref }}:versions.json)
          new_json=$(cat versions.json)
          added_keys=$(jq -r '(.addons | keys) - ($base.addons | keys)' --argjson base "$base_json" "$new_json")
          if [ -z "$added_keys" ] || [ "$added_keys" = "null" ]; then
            echo "‚ùå No new addons detected or existing ones modified."
            exit 1
          fi
          failed=""
          for key in $added_keys; do
            obj=$(echo "$new_json" | jq -r --arg key "$key" '.addons[$key]')
            for f in version releaseDate downloadUrl breaking urgent description external author homepage; do
              val=$(echo "$obj" | jq -r ".${f}")
              if [ "$val" = "null" ] || [ "$val" = "" ]; then
                failed+="\n‚ùå Missing field '$f' in $key"
              fi
            done
            ext=$(echo "$obj" | jq -r ".external")
            if [ "$ext" != "true" ]; then
              failed+="\n‚ùå Addon '$key' must have external: true"
            fi
          done
          if [ -n "$failed" ]; then
            echo -e "$failed"
            exit 1
          fi
          echo "‚úÖ Validation passed!"

  automerge:
    runs-on: ubuntu-latest
    needs: validate
    if: ${{ success() }}
    steps:
      - uses: peter-evans/enable-pull-request-automerge@v3
        with:
          pull-request-number: ${{ github.event.pull_request.number }}
          merge-method: squash
