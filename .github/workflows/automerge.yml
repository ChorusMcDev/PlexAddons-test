name: Auto Validator
on:
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Fetch versions.json from base and PR
        run: |
          echo "ðŸ“¥ Fetching versions.json from base and PR..."

          curl -s -o base.json \
            https://raw.githubusercontent.com/${{ github.repository }}/${{ github.base_ref }}/versions.json

          curl -s -o pr.json \
            https://raw.githubusercontent.com/${{ github.event.pull_request.head.repo.full_name }}/${{ github.event.pull_request.head.ref }}/versions.json

          echo "âœ… Files fetched:"
          ls -lh base.json pr.json

      - name: Validate PR changes
        id: validate
        run: |
          echo "ðŸ” Comparing base.json vs pr.json..."

          diff_output=$(diff -u base.json pr.json || true)
          echo "$diff_output" > diff.log

          added_lines=$(echo "$diff_output" | grep '^+' | grep -v '^+++' || true)
          removed_lines=$(echo "$diff_output" | grep '^-' | grep -v '^---' || true)

          echo "Added lines:"
          echo "$added_lines"
          echo "Removed lines:"
          echo "$removed_lines"

          if [ -z "$added_lines" ] && [ -z "$removed_lines" ]; then
            echo "âš ï¸ Warning: No file changes detected."
            echo "result=âš ï¸ Warning: No file changes detected." >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "âœ… Syntax check for versions.json..."
          jq empty pr.json || { 
            echo "âŒ Denied: Invalid JSON syntax in versions.json."
            echo "result=âŒ Denied: Invalid JSON syntax in versions.json." >> $GITHUB_OUTPUT
            exit 1
          }

          if [ -n "$removed_lines" ] && [ -z "$added_lines" ]; then
            echo "âŒ Denied: Removing entries is not allowed."
            echo "result=âŒ Denied: Removing entries is not allowed." >> $GITHUB_OUTPUT
            exit 1
          fi

          if [ -n "$added_lines" ] && [ -n "$removed_lines" ]; then
            # Check if only version/description changed
            if echo "$added_lines" | grep -Eq '"(version|description)":' && echo "$removed_lines" | grep -Eq '"(version|description)":'; then
              echo "ðŸ•“ Pending: Only version/description modified â€” manual review required."
              echo "result=ðŸ•“ Pending: Only version/description modified â€” manual review required." >> $GITHUB_OUTPUT
              exit 0
            fi

            echo "âŒ Denied: Modifying existing addons is not allowed."
            echo "result=âŒ Denied: Modifying existing addons is not allowed." >> $GITHUB_OUTPUT
            exit 1
          fi

          # If only added lines exist (new addons)
          if [ -n "$added_lines" ] && [ -z "$removed_lines" ]; then
            if echo "$added_lines" | grep -q '"external": false'; then
              echo "âŒ Denied: Only addons with \"external\": true can be added automatically."
              echo "result=âŒ Denied: Only addons with \"external\": true can be added automatically." >> $GITHUB_OUTPUT
              exit 1
            fi

            echo "âœ… Approved: All checks passed. Ready to merge!"
            echo "result=âœ… Approved: All checks passed. Ready to merge!" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "ðŸ•“ Pending: Could not determine change type â€” requires manual review."
          echo "result=ðŸ•“ Pending: Could not determine change type â€” requires manual review." >> $GITHUB_OUTPUT
          exit 0

      - name: Comment on PR
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "ðŸ’¬ Commenting validation results on PR #${PR_NUMBER}"
          gh pr comment "$PR_NUMBER" --body "ðŸ¤– Auto Validator Results [auto-validator]\n\n${{ steps.validate.outputs.result }}"

      - name: Enable auto-merge for approved PRs
        if: contains(steps.validate.outputs.result, 'Approved')
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          pull-request-number: ${{ github.event.pull_request.number }}
          merge-method: squash
