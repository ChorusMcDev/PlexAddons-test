name: Auto Merge Safe PRs

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: write

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - run: sudo apt-get install -y jq gh

      - id: validation
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          pr_number=${{ github.event.pull_request.number }}

          post_comment() {
            local msg="$1"
            echo "$msg" > body.txt
            gh pr comment "$pr_number" --edit-last --create-if-none -F body.txt || \
            gh pr comment "$pr_number" -F body.txt
          }

          msg="### ðŸ¤– Auto Validator Results [auto-validator]\n"

          changed=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          if [ "$changed" != "versions.json" ]; then
            post_comment "$msgâŒ **Denied:** Only \`versions.json\` may be modified. (Changed files: \`$changed\`)"
            exit 1
          fi

          removed=$(git diff origin/${{ github.base_ref }}...HEAD -- versions.json | grep '^-' | grep -v '^---' || true)
          if [ -n "$removed" ]; then
            post_comment "$msgâŒ **Denied:** You cannot remove or modify existing lines, only add new entries."
            exit 1
          fi

          if ! jq empty versions.json >/dev/null 2>&1; then
            post_comment "$msgâŒ **Denied:** Invalid JSON syntax in \`versions.json\`."
            exit 1
          fi

          base_json=$(git show origin/${{ github.base_ref }}:versions.json)
          new_json=$(cat versions.json)

          added_keys=$(jq -r '
            (.addons | keys) - ($base.addons | keys)
          ' --argjson base "$base_json" "$new_json")

          if [ -z "$added_keys" ] || [ "$added_keys" = "null" ]; then
            post_comment "$msgâŒ **Denied:** No new addon detected, or an existing one was modified. Only new *external* addons are allowed."
            exit 1
          fi

          failed=""
          for key in $added_keys; do
            obj=$(echo "$new_json" | jq -r --arg key "$key" '.addons[$key]')
            required=(version releaseDate downloadUrl breaking urgent description external author homepage)
            for f in "${required[@]}"; do
              v=$(echo "$obj" | jq -r ".${f}")
              if [ "$v" = "null" ] || [ "$v" = "" ]; then
                failed+="\nâŒ **$key:** Missing required field \`$f\`."
              fi
            done
            ext=$(echo "$obj" | jq -r ".external")
            if [ "$ext" != "true" ]; then
              failed+="\nâŒ **$key:** The \`external\` field must be set to **true**."
            fi
          done

          if [ -n "$failed" ]; then
            post_comment "$msgðŸš« **Validation failed:**$failed"
            exit 1
          fi

          post_comment "$msgâœ… **Approved!** All checks passed â€” this PR will be auto-merged."
          echo "ok=true" >> $GITHUB_OUTPUT

  enable-automerge:
    runs-on: ubuntu-latest
    needs: validate
    if: ${{ success() }}
    steps:
      - name: Enable auto-merge
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          pull-request-number: ${{ github.event.pull_request.number }}
          merge-method: squash
