name: Auto Merge Safe PRs

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: write

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - run: sudo apt-get install -y jq gh

      - id: validation
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          pr_number=${{ github.event.pull_request.number }}

          # Function to post or update PR comment
          post_comment() {
            local msg="$1"
            echo "$msg" > body.txt
            gh pr comment "$pr_number" --edit-last --create-if-none -F body.txt || \
            gh pr comment "$pr_number" -F body.txt
          }

          msg="### ðŸ¤– Auto Validator Results [auto-validator]"

          # Ensure both base and head refs exist
          git fetch origin ${{ github.base_ref }} ${{ github.head_ref }} --depth=1

          # Determine changed files
          changed=$(git diff --name-only origin/${{ github.base_ref }}...origin/${{ github.head_ref }} | xargs)

          if [ -z "$changed" ]; then
            post_comment "$msg\n\nâš ï¸ **Warning:** No file changes detected. Please make sure you actually modified \`versions.json\`."
            exit 1
          fi

          if [ "$changed" != "versions.json" ]; then
            formatted_files=$(echo "$changed" | sed 's/^/- /')
            post_comment "$msg\n\nâŒ **Denied:** Only \`versions.json\` may be modified.\n\n**Changed files:**\n$formatted_files"
            exit 1
          fi

          # Validate JSON syntax
          if ! jq empty versions.json >/dev/null 2>&1; then
            post_comment "$msg\n\nâŒ **Denied:** Invalid JSON syntax in \`versions.json\`.\n\nðŸ› ï¸ Please check your file with a JSON validator."
            exit 1
          fi

          # Get JSON before and after
          base_json=$(git show origin/${{ github.base_ref }}:versions.json)
          new_json=$(cat versions.json)

          # Find new addon keys
          added_keys=$(jq -r '
            (.addons | keys) - ($base.addons | keys)
          ' --argjson base "$base_json" "$new_json")

          if [ -z "$added_keys" ] || [ "$added_keys" = "null" ]; then
            post_comment "$msg\n\nâŒ **Denied:** No new addon detected, or an existing one was modified.\n\nðŸ§© Only **new external addons** can be automatically accepted."
            exit 1
          fi

          # Check each added addon
          failed=""
          for key in $added_keys; do
            obj=$(echo "$new_json" | jq -r --arg key "$key" '.addons[$key]')
            required=(version releaseDate downloadUrl breaking urgent description external author homepage)
            for f in "${required[@]}"; do
              v=$(echo "$obj" | jq -r ".${f}")
              if [ "$v" = "null" ] || [ "$v" = "" ]; then
                failed+="\n- **$key:** Missing required field \`$f\`."
              fi
            done
            ext=$(echo "$obj" | jq -r ".external")
            if [ "$ext" != "true" ]; then
              failed+="\n- **$key:** The \`external\` field must be set to **true**."
            fi
          done

          if [ -n "$failed" ]; then
            post_comment "$msg\n\nðŸš« **Validation failed:**\n$failed\n\nðŸ› ï¸ Please fix the issues above and push again."
            exit 1
          fi

          post_comment "$msg\n\nâœ… **Approved!**\n\nAll checks passed â€” the new addon(s) meet all validation rules.\nThis PR will be automatically merged soon. ðŸŽ‰"
          echo "ok=true" >> $GITHUB_OUTPUT

  enable-automerge:
    runs-on: ubuntu-latest
    needs: validate
    if: ${{ success() }}
    steps:
      - name: Enable auto-merge
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          pull-request-number: ${{ github.event.pull_request.number }}
          merge-method: squash
