name: Auto Validator
on:
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch PR branch
        run: |
          echo "ðŸ” Fetching base and PR branches..."
          git fetch origin ${{ github.base_ref }} --depth=1
          git fetch origin pull/${{ github.event.pull_request.number }}/head:pr-${{ github.event.pull_request.number }}
          echo "âœ… Fetched PR head as pr-${{ github.event.pull_request.number }}"

      - name: Validate PR changes
        id: validate
        run: |
          echo "ðŸ” Comparing origin/${{ github.base_ref }}...pr-${{ github.event.pull_request.number }}"
          changed=$(git diff --name-only origin/${{ github.base_ref }}...pr-${{ github.event.pull_request.number }} | xargs)
          echo "Changed files: $changed"

          if [ -z "$changed" ]; then
            echo "âš ï¸ Warning: No file changes detected."
            echo "result=âš ï¸ Warning: No file changes detected." >> $GITHUB_OUTPUT
            exit 0
          fi

          if [ "$changed" != "versions.json" ]; then
            echo "âŒ Denied: Only versions.json may be modified. (Changed files: $changed)"
            echo "result=âŒ Denied: Only versions.json may be modified. (Changed files: $changed)" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "âœ… Syntax check for versions.json..."
          jq empty versions.json || { echo "âŒ Denied: Invalid JSON syntax in versions.json."; echo "result=âŒ Denied: Invalid JSON syntax in versions.json." >> $GITHUB_OUTPUT; exit 1; }

          echo "ðŸ” Checking diff for types of changes..."
          added_lines=$(git diff origin/${{ github.base_ref }}...pr-${{ github.event.pull_request.number }} -- versions.json | grep '^+' | grep -v '^+++' || true)
          removed_lines=$(git diff origin/${{ github.base_ref }}...pr-${{ github.event.pull_request.number }} -- versions.json | grep '^-' | grep -v '^---' || true)

          if [ -n "$removed_lines" ] && [ -z "$added_lines" ]; then
            echo "âŒ Denied: Removing entries is not allowed."
            echo "result=âŒ Denied: Removing entries is not allowed." >> $GITHUB_OUTPUT
            exit 1
          fi

          if [ -z "$added_lines" ] && [ -n "$removed_lines" ]; then
            echo "âŒ Denied: You cannot remove data from versions.json."
            echo "result=âŒ Denied: You cannot remove data from versions.json." >> $GITHUB_OUTPUT
            exit 1
          fi

          if [ -n "$added_lines" ] && [ -n "$removed_lines" ]; then
            # Check if only version or description fields changed
            if echo "$added_lines" | grep -Eq '"(version|description)":' && echo "$removed_lines" | grep -Eq '"(version|description)":'; then
              echo "ðŸ•“ Pending: Only version/description modified â€” manual review required."
              echo "result=ðŸ•“ Pending: Only version/description modified â€” manual review required." >> $GITHUB_OUTPUT
              exit 0
            fi

            echo "âŒ Denied: Modifying existing addons is not allowed."
            echo "result=âŒ Denied: Modifying existing addons is not allowed." >> $GITHUB_OUTPUT
            exit 1
          fi

          # If only new lines were added (new addons)
          if [ -n "$added_lines" ] && [ -z "$removed_lines" ]; then
            if echo "$added_lines" | grep -q '"external": false'; then
              echo "âŒ Denied: Only addons with \"external\": true can be added automatically."
              echo "result=âŒ Denied: Only addons with \"external\": true can be added automatically." >> $GITHUB_OUTPUT
              exit 1
            fi
            echo "âœ… Approved: All checks passed. Ready to merge!"
            echo "result=âœ… Approved: All checks passed. Ready to merge!" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "ðŸ•“ Pending: Could not determine change type â€” requires manual review."
          echo "result=ðŸ•“ Pending: Could not determine change type â€” requires manual review." >> $GITHUB_OUTPUT
          exit 0

      - name: Comment on PR
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "ðŸ’¬ Commenting validation results on PR #${PR_NUMBER}"
          gh pr comment "$PR_NUMBER" --body "ðŸ¤– Auto Validator Results [auto-validator]\n\n${{ steps.validate.outputs.result }}"

      - name: Enable auto-merge for approved PRs
        if: contains(steps.validate.outputs.result, 'Approved')
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          pull-request-number: ${{ github.event.pull_request.number }}
          merge-method: squash
