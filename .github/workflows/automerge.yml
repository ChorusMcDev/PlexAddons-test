name: Auto Validator

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      result: ${{ steps.validate.outputs.result }}

    steps:
      - name: ðŸ” Fetch base and PR versions.json
        id: fetch
        run: |
          echo "Fetching base and PR versions.json..."
          curl -s -o base.json https://raw.githubusercontent.com/${{ github.repository }}/${{ github.base_ref }}/versions.json
          curl -s -o pr.json https://raw.githubusercontent.com/${{ github.event.pull_request.head.repo.full_name }}/${{ github.event.pull_request.head.ref }}/versions.json

            - name: ðŸ”Ž Validate versions.json changes
        id: validate
        run: |
          echo "ðŸ” Comparing base.json vs pr.json..."
          diff_output=$(diff -u base.json pr.json || true)

          added=$(echo "$diff_output" | grep '^+' | grep -v -- '+++' || true)
          removed=$(echo "$diff_output" | grep '^-' | grep -v -- '---' || true)

          echo "Added lines:"
          echo "$added"
          echo "Removed lines:"
          echo "$removed"

          # Syntax validation
          echo "âœ… Syntax check for versions.json..."
          if ! jq empty pr.json; then
            echo "result=âŒ Denied: Invalid JSON syntax." >> $GITHUB_OUTPUT
            exit 0
          fi

          # Only one file changed rule
          changed_files=$(echo "$added$removed" | wc -l)
          if [[ $changed_files -eq 0 ]]; then
            echo "result=âš ï¸ Warning: No file changes detected." >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if PR modifies non-external addons
          if echo "$added$removed" | grep -q '"external": false'; then
            echo "result=âŒ Denied: Modifying internal addons is not allowed." >> $GITHUB_OUTPUT
            exit 0
          fi

          # Detect edits vs additions
          added_addons=$(echo "$added" | grep '"addons"' | wc -l)
          removed_addons=$(echo "$removed" | grep '"addons"' | wc -l)

          # If new addon added and it's external -> allow
          if echo "$added" | grep -q '"external": true' && [[ $removed_addons -eq 0 ]]; then
            echo "result=âœ… Approved: All checks passed. Ready to merge!" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Allow small edits only to version/description/releaseDate
          if echo "$added$removed" | grep -Eq '"(version|description|releaseDate)"' && \
             ! echo "$added$removed" | grep -Eq '"external":|addons";|downloadUrl|homepage|author|breaking|urgent'; then
            echo "result=â³ Pending: Manual review required for version/description/releaseDate edits." >> $GITHUB_OUTPUT
            exit 0
          fi

          # If any other change occurs -> deny
          echo "result=âŒ Denied: Modifying existing addons is not allowed." >> $GITHUB_OUTPUT
          exit 0

      - name: Checkout for gh CLI
        if: always()
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 1

      - name: ðŸ’¬ Comment validation results on PR
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "ðŸ’¬ Commenting validation results on PR #${PR_NUMBER}"
          gh pr comment "$PR_NUMBER" -R "${{ github.repository }}" --delete-last --yes || true
          gh pr comment "$PR_NUMBER" -R "${{ github.repository }}" --body $'ðŸ¤– **Auto Validator Results [auto-validator]**\n\n${{ steps.validate.outputs.result }}'

      - name: âœ… Enable auto-merge for approved PRs
        if: contains(steps.validate.outputs.result, 'Approved')
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          pull-request-number: ${{ github.event.pull_request.number }}
          merge-method: squash
